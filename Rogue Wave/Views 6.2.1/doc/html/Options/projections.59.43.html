<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="false" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><!-- RW Customization - favicon file --><link rel="shortcut icon" href="connect/favicon.ico" /><title>Step 2: Defining a New Projection</title><link rel="Prev" href="projections.59.42.html" title="Previous" /><link rel="Next" href="projections.59.44.html" title="Next" /><link rel="StyleSheet" href="css/projections.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><!--[if IE 7]><link rel="StyleSheet" href="css/projections_IE7.css" type="text/css" media="all" /><![endif]--><link rel="StyleSheet" href="css/custom.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if ((window === window.top) && (window.navigator.userAgent.indexOf('bot/') === -1)) {
        // Redirect
        //
        redirect_url = "../views.html#page/Options/projections.59.43.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-111257570-3']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body id="pN_002fyy5IddzO48j9jGp0zLRGg" class="ww_skin_page_body" onload="Page.OnLoad('../views.html#page/Options/projections.59.43.html');"><header id="wwconnect_header"><div class="ww_skin_breadcrumbs"><span class="ww_skin_breadcrumbs_parent"><a href="../Options/docfrontcover.html#wwconnect_header">Maps</a></span><span class="ww_skin_breadcrumbs_divider"> &gt; </span><span class="ww_skin_breadcrumbs_parent"><a href="../Options/projections.59.01.html#wwconnect_header">Map Projections</a></span><span class="ww_skin_breadcrumbs_divider"> &gt; </span><span class="ww_skin_breadcrumbs_parent"><a href="../Options/projections.59.38.html#wwconnect_header">Creating a New Projection</a></span><span class="ww_skin_breadcrumbs_divider"> &gt; </span><span class="ww_skin_breadcrumbs_current">Step 2: Defining a New Projection</span></div><div class="ww_skin_page_toolbar"><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#">&nbsp;</a></div></header><div id="ww1012244" class="Heading2"><span></span>Step 2: Defining a New Projection</div><div id="ww1012245" class="Body">This step explains how to add parameters to a projection, and how to write the Input/Output functions to support these additional parameters. It also shows how to create specific error codes.</div><div id="ww1012246" class="Body">The complete code of this projection is in the files <span class="code">proj_step2.h</span> and <span class="code">proj_step2.cpp</span>.</div><div id="ww1012247" class="Subhead"><span></span>Defining a New Parameter</div><div id="ww1012248" class="Body">The Mercator projection does not maintain distances. With the Mercator projection, the scale factor changes with the latitude: the further a point is from the equator, the larger the scale factor. However, it is possible to specify the latitude of the true scale, that is, the latitude around which the distances between the projected points are maintained.</div><div id="ww1012249" class="Body">In our example, we will introduce this new parameter and manage its persistence.</div><div id="ww1012250" class="Subhead"><span></span>Defining a New Error Code</div><div id="ww1012251" class="Body">As we saw in the previous step with the Mercator projection, the forward projection of a point can cause an error if the point is too close to a pole. Instead of returning the generic <span class="code">IlvProjection::ToleranceConditionError()</span>, we will create a specific error code that will be returned in this case.</div><div id="ww1012252" class="Subhead"><span></span>Declaring the New Class</div><div id="ww1012253" class="Body">The second version of the Mercator class is declared in the file <span class="code">proj_step2.h</span>.</div><div id="ww1012254" class="Body">We have added:</div><div id="ww1012255" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a method to set the latitude of the true scale,</div><div id="ww1012256" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a method to get the latitude of the true scale,</div><div id="ww1012257" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a static method <span class="code">PolarZoneError</span> to get the specific error code of the Mercator projection,</div><div id="ww1012258" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a virtual <span class="code">write</span> method that overrides the default <span class="code">IlvProjection::write</span> method,</div><div id="ww1012259" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a private static method <span class="code">InitClass</span> that will be used to allocate the new error code,</div><div id="ww1012260" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a private field to store the latitude of the true scale, and</div><div id="ww1012261" class="Itemize"><span class="WebWorks_Number" style="width: 14.173228346456696pt"><span><img src="bullet.gif" alt="*" border="0" width="8" height="8" /></span></span>a private static field to store the error code.</div><div id="ww1012262" class="NormalCode">class Mercator : public IlvProjection</div><div id="ww1013263" class="NormalCode">{</div><div id="ww1013264" class="NormalCode">public:</div><div id="ww1013265" class="NormalCode">    Mercator();</div><div id="ww1013266" class="NormalCode">&nbsp;</div><div id="ww1013267" class="NormalCode">    void setLatitudeOfTrueScale(IlvDouble latitudeOfTrueScale)</div><div id="ww1013268" class="NormalCode">    {_latitudeOfTrueScale = latitudeOfTrueScale;}</div><div id="ww1013269" class="NormalCode">&nbsp;</div><div id="ww1013270" class="NormalCode">    IlvDouble getLatitudeOfTrueScale() const </div><div id="ww1013271" class="NormalCode">    {return _latitudeOfTrueScale;}</div><div id="ww1013272" class="NormalCode">&nbsp;</div><div id="ww1013273" class="NormalCode">    static IlvMapsError PolarZoneError() {return _polarZoneError;}</div><div id="ww1013274" class="NormalCode">&nbsp;</div><div id="ww1013275" class="NormalCode">    virtual void write(IlvOutputFile&amp;) const;</div><div id="ww1013276" class="NormalCode">    </div><div id="ww1013277" class="NormalCode">protected:</div><div id="ww1013278" class="NormalCode">    virtual IlvMapsError sForward(IlvCoordinate &amp;) const;</div><div id="ww1013279" class="NormalCode">    virtual IlvMapsError sInverse(IlvCoordinate &amp;) const;</div><div id="ww1013280" class="NormalCode">    virtual IlvMapsError eForward(IlvCoordinate &amp;) const;</div><div id="ww1013281" class="NormalCode">    virtual IlvMapsError eInverse(IlvCoordinate &amp;) const;</div><div id="ww1013282" class="NormalCode">    </div><div id="ww1013283" class="NormalCode">private:</div><div id="ww1013284" class="NormalCode">    static void InitClass();</div><div id="ww1013285" class="NormalCode">    </div><div id="ww1013286" class="NormalCode">private:</div><div id="ww1013287" class="NormalCode">    IlvDouble _latitudeOfTrueScale;</div><div id="ww1013288" class="NormalCode">    static IlvMapsError _polarZoneError;</div><div id="ww1013289" class="NormalCode">    </div><div id="ww1013290" class="NormalCode">    IlvMapsDeclareProjectionIO(Mercator);</div><div id="ww1013291" class="LastNormalCode">};</div><div id="ww1012263" class="Subhead"><span></span>Defining The Projection</div><div id="ww1012264" class="Body">The projection is defined in the file <span class="code">proj_step2.cpp</span>.</div><div id="ww1012265" class="Body">To define the class, use the <span class="code">IlvMapsDefineProjectionIO</span> macro. This macro must be used instead of the <span class="code">IlvMapsDefineBasicProjectionIO</span> macro for projections that have to save additional parameters.</div><div id="ww1012266" class="Body">In this step, the initialization statement of the macro is set to the static private function <span class="code">Mercator::InitClass()</span>, which will initialize the error code. It is possible to call a static private function of the Mercator class at this place because the <span class="code">IlvMapsDefineProjectionIO</span> macro generates the initialization statement in a scope that has been declared as <span class="code">friend</span> of the <span class="code">Mercator</span> class by the <span class="code">IlvMapsDeclareProjectionIO</span> macro.</div><div id="ww1012267" class="NormalCode">IlvMapsDefineProjectionIO(Mercator,</div><div id="ww1013292" class="NormalCode">                          IlvProjection,</div><div id="ww1013293" class="NormalCode">                          "My Mercator Implementation",</div><div id="ww1013294" class="NormalCode">                          new Mercator(),</div><div id="ww1013295" class="LastNormalCode">                          Mercator::InitClass());</div><div id="ww1012268" class="Subhead"><span></span>Initializing the Error Code</div><div id="ww1012269" class="Body">The new error code is allocated by the <span class="code">InitClass</span> method, which is automatically called during the static initialization phase.</div><div id="ww1012270" class="NormalCode">void</div><div id="ww1013300" class="NormalCode">Mercator::InitClass()</div><div id="ww1013296" class="NormalCode">{</div><div id="ww1013297" class="NormalCode">    _polarZoneError = </div><div id="ww1013298" class="NormalCode">         IlvMaps::CreateError("&amp;MercatorPolarZoneError");</div><div id="ww1013299" class="LastNormalCode">}</div><div id="ww1012271" class="Subhead"><span></span>Using the New Parameter and the New Error Code</div><div id="ww1012272" class="Body">The latitude of the true scale and the new error code are used in the forward and inverse functions. The following is an example of the way they are used in the projection functions.</div><div id="ww1012273" class="NormalCode">IlvMapsError</div><div id="ww1013301" class="NormalCode">Mercator::sForward(IlvCoordinate&amp; ll) const</div><div id="ww1013302" class="NormalCode">{</div><div id="ww1013303" class="NormalCode">    if (fabs(fabs(ll.y()) - IlvMaps::Pi() / 2.) &lt;= 1e-10)</div><div id="ww1013304" class="NormalCode">       // Returning the specific error code.</div><div id="ww1013305" class="NormalCode">       return PolarZoneError();</div><div id="ww1013306" class="NormalCode">&nbsp;</div><div id="ww1013307" class="NormalCode">    IlvDouble k = cos(_latitudeOfTrueScale);</div><div id="ww1013308" class="NormalCode">    ll.setY(k * log(tan(IlvMaps::Pi() / 4. + 0.5 * ll.y())));</div><div id="ww1013309" class="NormalCode">    ll.setX(k * ll.x());</div><div id="ww1013310" class="NormalCode">    return IlvMaps::NoError();</div><div id="ww1013311" class="LastNormalCode">}</div><div id="ww1012274" class="Subhead"><span></span>Writing the Input/Output Functions for the New Parameter</div><div id="ww1012275" class="Body">To provide complete IO support for the new parameter, you must implement a <span class="code">write</span> method to save this additional parameter. This <span class="code">write</span> method must call the <span class="code">write</span> method of its superclass before writing any data.</div><div id="ww1012276" class="NormalCode">void Mercator::write(IlvOutputFile &amp;file) const</div><div id="ww1013312" class="NormalCode">{</div><div id="ww1013313" class="NormalCode">    IlvProjection::write(file);</div><div id="ww1013314" class="NormalCode">    file.getStream() &lt;&lt; _latitudeOfTrueScale &lt;&lt; IlvSpc();</div><div id="ww1013315" class="LastNormalCode">}</div><div id="ww1012277" class="Body">You must also implement a read constructor. This read constructor calls the read constructor of its superclass and then reads the latitude of the true scale.</div><div id="ww1012278" class="NormalCode">Mercator::Mercator(IlvInputFile&amp; file)</div><div id="ww1013316" class="NormalCode">:IlvProjection(file)</div><div id="ww1013317" class="NormalCode">{</div><div id="ww1013318" class="NormalCode">    file.getStream() &gt;&gt; _latitudeOfTrueScale;</div><div id="ww1013319" class="LastNormalCode">}</div><div id="ww1012279" class="Body">Finally, the copy constructor must also be updated to implement the copy of this new parameter.</div><div id="ww1012280" class="NormalCode">Mercator::Mercator(const Mercator&amp; source)</div><div id="ww1013323" class="NormalCode">:IlvProjection(source),</div><div id="ww1013324" class="NormalCode"> _latitudeOfTrueScale(source._latitudeOfTrueScale)</div><div id="ww1013325" class="NormalCode">{</div><div id="ww1013326" class="LastNormalCode">}</div><footer><!-- Related Topics --><!--                --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><div class="ww_skin_page_globalization"><div id="google_translate_element">&nbsp;</div><script><!--
            function googleTranslateElementInit() {
              new google.translate.TranslateElement({
                  pageLanguage: '',
                  autoDisplay: true
                }, 'google_translate_element');
            }
// --></script></div><br /></footer><HR /><div style="font-size: 8pt; font-family: verdana; font-weight: normal; text-align: center;">Version 6.2.1</div><div style="font-size: 8pt; font-family: verdana; font-weight: normal; text-align: center;">Copyright © 2018, Rogue Wave Software, Inc. All Rights Reserved.</div></body></html>